#!/bin/bash

# Since 5.2
# Create one file for each secret to make it easier to manage them with Docker secrets

echo "#############################################"
echo "üîê Ensuring wiki secrets"

# b/c If the /data/wiki/.wikienv file exists, we must extract the env vars from it and store it in the new files
declare -A legacy_env_vars
if [ ! -f /data/wiki/.wikienv ]; then
  echo "No legacy .wikienv file found, skipping conversion."
else
  echo "Convert legacy .wikienv file."
  while IFS='=' read -r key value; do
  [[ -z "$key" ]] && continue
  legacy_env_vars["$key"]="$value"
  done < /data/wiki/.wikienv
fi

# Set either from env_vars or generate a new random value
declare -A secrets=(
  ["INTERNAL_CHAT_TOKEN"]=64
  ["INTERNAL_CHAT_WIKI_ACCESS_TOKEN"]=64
  ["INTERNAL_SIMPLESAMLPHP_ADMIN_PASS"]=16
  ["INTERNAL_SIMPLESAMLPHP_SECRET_SALT"]=64
  ["INTERNAL_WIKI_UPGRADEKEY"]=16
  ["INTERNAL_WIKI_SECRETKEY"]=64
  ["INTERNAL_WIKI_TOKEN_AUTH_SALT"]=64
  ["INTERNAL_WIRE_API_KEY"]=64
)

secrets_dir="/data/.secrets"
mkdir -p $secrets_dir

for var_name in ${!secrets[@]}; do
  length=${secrets[$var_name]}
  file_path="$secrets_dir/$var_name"
  echo "Processing secret for $var_name..."
  if [ -f "$file_path" ]; then
    echo "Secret file already exists, skipping."
  else
    if [ -n "${!var_name}" ]; then
      echo "Using provided environment variable."
      echo -n "${!var_name}" > "$file_path"
    elif [ -n "${legacy_env_vars[$var_name]}" ]; then
      echo "Using legacy .wikienv value."
      echo -n "${legacy_env_vars[$var_name]}" > "$file_path"
    else
      echo "Generating new random value."
      openssl rand -base64 $length | tr -d '/+=' | cut -c1-$length > "$file_path"
    fi
    chmod 644 "$file_path"
  fi
done

# Echo "obsolete" method into legacy .wikienv file to avoid confusion
if [ -f /data/wiki/.wikienv ]; then
  echo "# This file is obsolete since BlueSpice 5.2. Secrets are now stored in individual files in the /data/secrets directory." >> /data/wiki/.wikienv
  echo "# You can safely delete this file." >> /data/wiki/.wikienv
  echo "" >> /data/wiki/.wikienv
fi
