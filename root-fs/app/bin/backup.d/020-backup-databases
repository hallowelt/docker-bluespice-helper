#!/bin/bash
MYSQL_SERVER=${DB_HOST:-'database'}
MYSQL_USER=${DB_USER:-'bluespice'}
MYSQL_PASS=${DB_PASS}
MYSQL_PREFIX=${DB_PREFIX}

function mysql_connect() {
    mysql -h ${MYSQL_SERVER} -u ${MYSQL_USER} -p${MYSQL_PASS} $*
}
function mysql_dump() {
    mysqldump -h ${MYSQL_SERVER} -u ${MYSQL_USER} -p${MYSQL_PASS} --single-transaction $*
}

#LIST DATABASES
DATABASES=$(mysql_connect <<< "SHOW DATABASES;" | awk -F " " '{if (NR!=1) print $1}' | grep -v information_schema | grep -v mysql | grep -v sys | grep -v test | grep -v performance_schema)

# Create an array with the database names
readarray -t aDB <<< "$DATABASES"

# run sql-command
for sDB in "${aDB[@]}"; do
    IGNORE_TABLES=$(mysql_connect <<< "select group_concat(concat('--ignore-table=', TABLE_SCHEMA, '.', table_name) SEPARATOR ' ')  from information_schema.tables  where TABLE_SCHEMA = 'bluespice' and TABLE_NAME like '%cache%' or TABLE_NAME like '%dpl_clview%' or TABLE_NAME like '%smw_%';" | awk 'NR>1')
    if [[ -f ${BLUESPICE_DATABASE_BACKUP_DIRECTORY}/${sDB}.sql ]]; then
    	rm -fr ${BLUESPICE_DATABASE_BACKUP_DIRECTORY}/${sDB}.sql 
    fi
    ##DUMP SCHEMA
    mysql_dump --no-data ${sDB} > ${BLUESPICE_DATABASE_BACKUP_DIRECTORY}/${sDB}.sql 
    ##DUMP DATA
    mysql_dump --no-create-info ${IGNORE_TABLES} ${sDB} >> ${BLUESPICE_DATABASE_BACKUP_DIRECTORY}/${sDB}.sql 
done